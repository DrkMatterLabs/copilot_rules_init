/**
 * GitHub Copilot CLI Custom Agent Generator
 * Generates .github/agents/*.md files for GitHub Copilot CLI
 */

/**
 * Generate a custom agent profile for GitHub Copilot CLI
 * @param {Object} config - Project configuration
 * @returns {string} - Markdown content for the agent profile
 */
function generateAgentProfile(config) {
  const {
    projectName,
    projectType,
    domain,
    features = [],
    techStack = [],
    monorepo = {},
    workflow = {}
  } = config;

  // Determine agent name (lowercase, hyphenated)
  const agentName = projectName.toLowerCase().replace(/[^a-z0-9]+/g, '-');

  // Build description
  const description = `Specialized agent for the ${projectName} project${domain ? `: ${domain}` : ''}`;

  // Build tech stack section
  const techStackSection = techStack.length > 0
    ? `\n## Technology Stack\n\nThis project uses:\n${techStack.map(tech => `- ${tech}`).join('\n')}\n`
    : '';

  // Build features section
  const featuresSection = features.length > 0
    ? `\n## Key Features\n\n${features.map(feature => `- ${feature}`).join('\n')}\n`
    : '';

  // Build monorepo structure section
  const monorepoSection = monorepo.frontendDir || monorepo.backendDir
    ? `\n## Project Structure\n\n${monorepo.frontendDir ? `- Frontend: \`${monorepo.frontendDir}/\`\n` : ''}${monorepo.backendDir ? `- Backend: \`${monorepo.backendDir}/\`\n` : ''}`
    : '';

  // Build workflow guidelines
  const workflowSection = workflow.branchPrefix || workflow.autoBuild
    ? `\n## Development Workflow\n\n${workflow.branchPrefix ? `- Branch naming: \`${workflow.branchPrefix}/[feature-name]\`\n` : ''}${workflow.autoBuild ? `- Always run build/tests before committing\n` : ''}${workflow.targetBranch ? `- Target branch for PRs: \`${workflow.targetBranch}\`\n` : ''}`
    : '';

  // Generate project-specific guidelines based on type
  const guidelinesSection = generateTypeSpecificGuidelines(projectType, config);

  // Build the complete agent profile
  return `---
name: ${agentName}
description: ${description}
---

# ${projectName} Development Agent

You are an expert development assistant specialized for the **${projectName}** project.
${techStackSection}${featuresSection}${monorepoSection}
## Your Responsibilities

- Understand and respect the project's architecture and conventions
- Write clean, maintainable, and well-documented code
- Follow the existing patterns in the codebase
- Suggest improvements while maintaining consistency${workflow.autoBuild ? '\n- Ensure all builds and tests pass before suggesting commits' : ''}
- Ask for clarification when requirements are ambiguous
${workflowSection}${guidelinesSection}
## Code Quality Standards

- Write production-ready code with proper error handling
- Include appropriate validation and edge case handling
- Follow the principle of least surprise
- Keep functions focused and maintainable
- Write self-documenting code with clear variable names
- Add comments only for complex logic or non-obvious decisions

## Communication Style

- Be concise but complete
- Explain complex decisions briefly
- Suggest alternatives when appropriate
- Never make destructive changes without confirmation
- Highlight potential breaking changes

---

*This agent was auto-generated by copilot-init. Edit this file to customize behavior.*
`;
}

/**
 * Generate type-specific guidelines based on project type
 * @param {string} projectType - Type of project (nextjs, rails, fullstack, etc.)
 * @param {Object} config - Full project configuration
 * @returns {string} - Type-specific guidelines section
 */
function generateTypeSpecificGuidelines(projectType, config) {
  switch (projectType) {
    case 'nextjs':
      return `
## Next.js Specific Guidelines

- Use TypeScript for all new files
- Follow the App Router conventions (app directory structure)
- Prefer Server Components by default, use 'use client' only when needed
- Use Next.js built-in features (Image, Link, etc.) instead of raw HTML
- Implement proper data fetching patterns (server-side when possible)
- Follow React best practices and hooks rules
- Write responsive, accessible UI components
- Use Tailwind CSS if available in the project
- Optimize for performance and Core Web Vitals

## Testing & Build

- Run \`npm run build\` to validate the build before committing
- Run tests with \`npm test\` if available
- Check TypeScript types with \`npm run type-check\` if available
`;

    case 'rails':
      return `
## Ruby on Rails Specific Guidelines

- Follow Rails conventions (RESTful routing, MVC pattern)
- Use ActiveRecord idiomatically (scopes, validations, associations)
- Write database migrations safely (reversible, data-preserving)
- Follow Ruby style guide and use RuboCop if available
- Implement proper error handling and validations
- Use Rails helpers and view partials appropriately
- Keep controllers thin, models fat (business logic in models)
- Use concerns for shared behavior
- Follow the Rails Way unless there's a good reason not to

## Testing & Quality

- Run \`bundle exec rails test\` or \`bundle exec rspec\` before committing
- Write tests for new features and bug fixes
- Check migration status with \`rails db:migrate:status\`
- Ensure seeds and fixtures are up to date
`;

    case 'fullstack':
      return `
## Full-Stack Guidelines

### Backend (Rails)

- Follow Rails conventions and RESTful API design
- Use proper API versioning (e.g., /api/v1/)
- Implement comprehensive error handling for API endpoints
- Use serializers for consistent JSON responses
- Write API documentation for new endpoints
- Validate input data rigorously

### Frontend (Next.js)

- Use TypeScript for type-safe API client code
- Implement proper loading and error states
- Cache API responses appropriately
- Handle authentication tokens securely
- Follow React best practices

### Integration

- Coordinate API changes with frontend updates
- Test API endpoints before updating frontend
- Document API contracts clearly
- Handle backward compatibility carefully
- Validate data flow end-to-end

## Testing

- Run backend tests: \`bundle exec rails test\`
- Run frontend build: \`npm run build\`
- Test API integration points
- Verify CORS and authentication flow
`;

    case 'monorepo':
      return `
## Monorepo Guidelines

- Respect workspace boundaries and dependencies
- Use workspace-level scripts when available
- Keep shared code in appropriate packages
- Maintain consistent tooling across workspaces
- Update dependencies carefully (consider impact on other packages)
- Test affected packages when making shared changes
- Follow the established build order and dependency graph

## Cross-Package Development

- Understand package interdependencies
- Use proper import paths for workspace packages
- Keep package interfaces stable
- Document breaking changes in shared packages
- Test downstream effects of changes
`;

    default:
      return `
## General Development Guidelines

- Follow the established patterns in the codebase
- Write tests for new functionality
- Keep dependencies up to date
- Document complex logic and non-obvious decisions
- Use version control effectively (meaningful commits, proper branching)
- Consider security implications of changes
- Optimize for readability and maintainability
`;
  }
}

module.exports = {
  generateAgentProfile,
  generateTypeSpecificGuidelines
};
